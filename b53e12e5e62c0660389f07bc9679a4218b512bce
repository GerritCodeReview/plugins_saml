{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "ca2758c3_527658c5",
        "filename": "/COMMIT_MSG",
        "patchSetId": 2
      },
      "lineNbr": 17,
      "author": {
        "id": 1063024
      },
      "writtenOn": "2023-09-04T15:19:46Z",
      "side": 1,
      "message": "This is true for this plugin/application interaction, however SamlMembership still uses uses a header to pass the display name. According to the comments this is done for LDAP syncing. I don\u0027t know if this is an issue, but should we need to address it, it can be done in a separate change.\n\nAny concerns?",
      "revId": "b53e12e5e62c0660389f07bc9679a4218b512bce",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "841155db_1a21fd30",
        "filename": "/COMMIT_MSG",
        "patchSetId": 2
      },
      "lineNbr": 17,
      "author": {
        "id": 1063024
      },
      "writtenOn": "2023-09-05T08:50:35Z",
      "side": 1,
      "message": "Acknowledged",
      "parentUuid": "ca2758c3_527658c5",
      "revId": "b53e12e5e62c0660389f07bc9679a4218b512bce",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "d1b0c3d4_a401c63b",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2023-09-05T07:38:10Z",
      "side": 1,
      "message": "I believe we should move this to stable-3.2, even if the version is EOL, otherwise users won\u0027t be able to use the SAML integration properly for 7 versions versions between v3.2 and v3.9",
      "revId": "b53e12e5e62c0660389f07bc9679a4218b512bce",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "139c7352_902dc21f",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1054778
      },
      "writtenOn": "2023-09-05T08:50:27Z",
      "side": 1,
      "message": "+1",
      "parentUuid": "d1b0c3d4_a401c63b",
      "revId": "b53e12e5e62c0660389f07bc9679a4218b512bce",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "1657039f_7446ca02",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1063024
      },
      "writtenOn": "2023-09-05T08:50:35Z",
      "side": 1,
      "message": "Sure, will do.",
      "parentUuid": "d1b0c3d4_a401c63b",
      "revId": "b53e12e5e62c0660389f07bc9679a4218b512bce",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "177e96d2_087fe55f",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1063024
      },
      "writtenOn": "2023-09-05T09:21:48Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "1657039f_7446ca02",
      "revId": "b53e12e5e62c0660389f07bc9679a4218b512bce",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "b1f5b016_ff3e39e8",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/saml/SamlWebFilter.java",
        "patchSetId": 2
      },
      "lineNbr": 182,
      "author": {
        "id": 1063024
      },
      "writtenOn": "2023-09-04T15:19:46Z",
      "side": 1,
      "message": "The test passes without setting the request context, but when running the app it\u0027s required. I suppose this is because we inject the same admin GerritApi instance. Anyway, this call isn\u0027t covered by regression.",
      "revId": "b53e12e5e62c0660389f07bc9679a4218b512bce",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "9426ce59_4630bc7e",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/saml/SamlWebFilter.java",
        "patchSetId": 2
      },
      "lineNbr": 182,
      "author": {
        "id": 1054778
      },
      "writtenOn": "2023-09-04T16:13:37Z",
      "side": 1,
      "message": "Can you maybe add a comment explaining why we need to make this call after the `doFilter`?\n\nJust to double check this means that:\n1. we will create the user with the wrong display name and then correct it\n2. every time the user will login, we will do this call\n\nRegarding 2: is the All-Users modified everytime or if display name is unchanged this translates in a noop?\n\nIn any case, I think it might not be a big deal since you don\u0027t normally logout when using SAML.",
      "revId": "b53e12e5e62c0660389f07bc9679a4218b512bce",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "580e3b78_3d4f6a0d",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/saml/SamlWebFilter.java",
        "patchSetId": 2
      },
      "lineNbr": 182,
      "author": {
        "id": 1063024
      },
      "writtenOn": "2023-09-04T20:58:07Z",
      "side": 1,
      "message": "Re: `doFilter`, this call has to happen after said method because before it our user won\u0027t have an account, so the GerritApi call will fail.\n\nWith respect to your other points:\n1. I think this is the case, yes. However in the next change in this chain we don\u0027t set the header anymore, so this call would then set it for the first time. FWIW in both cases this all happens before the page is rendered, so it should be transparent to the user.\n2. Yes, that\u0027s correct. We could check what the name is first, and only do the update if it differs. WDYT?",
      "parentUuid": "9426ce59_4630bc7e",
      "revId": "b53e12e5e62c0660389f07bc9679a4218b512bce",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "4c25f68f_8387f44a",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/saml/SamlWebFilter.java",
        "patchSetId": 2
      },
      "lineNbr": 182,
      "author": {
        "id": 1063024
      },
      "writtenOn": "2023-09-05T08:50:35Z",
      "side": 1,
      "message": "Tested this, and it looks like Gerrit is clever enough to only update if the name changes, so we don\u0027t need to #2.",
      "parentUuid": "580e3b78_3d4f6a0d",
      "revId": "b53e12e5e62c0660389f07bc9679a4218b512bce",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "07c78c82_abf303a3",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/saml/SamlWebFilter.java",
        "patchSetId": 2
      },
      "lineNbr": 184,
      "author": {
        "id": 1063024
      },
      "writtenOn": "2023-09-04T20:58:07Z",
      "side": 1,
      "message": "Is there a terser way to get `Account.Id`?",
      "revId": "b53e12e5e62c0660389f07bc9679a4218b512bce",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "d901c933_e4e53267",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/saml/SamlWebFilter.java",
        "patchSetId": 2
      },
      "lineNbr": 184,
      "author": {
        "id": 1054778
      },
      "writtenOn": "2023-09-05T08:50:27Z",
      "side": 1,
      "message": "The way you did it is ok",
      "parentUuid": "07c78c82_abf303a3",
      "revId": "b53e12e5e62c0660389f07bc9679a4218b512bce",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "a151ea5c_fbb4981d",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/saml/SamlWebFilter.java",
        "patchSetId": 2
      },
      "lineNbr": 184,
      "author": {
        "id": 1063024
      },
      "writtenOn": "2023-09-05T08:50:35Z",
      "side": 1,
      "message": "Acknowledged",
      "parentUuid": "07c78c82_abf303a3",
      "revId": "b53e12e5e62c0660389f07bc9679a4218b512bce",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "3764531e_9b5670c5",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/saml/SamlWebFilter.java",
        "patchSetId": 2
      },
      "lineNbr": 185,
      "author": {
        "id": 1063024
      },
      "writtenOn": "2023-09-04T16:11:16Z",
      "side": 1,
      "message": "This call has to happen _after_ `doFilter`. This is because if we do it before, the user won\u0027t have been authenticated and their account will not be available.\n\nI originally had this in another branch, but that made it difficult to find the condition to trigger this call. Doing it here means it\u0027s done once after a successful login.",
      "revId": "b53e12e5e62c0660389f07bc9679a4218b512bce",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "2525c881_627e6c72",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/saml/SamlWebFilter.java",
        "patchSetId": 2
      },
      "lineNbr": 185,
      "author": {
        "id": 1014252
      },
      "writtenOn": "2023-09-05T09:07:07Z",
      "side": 1,
      "message": "Let\u0027s say I log in to my SAML authenticated Gerrit server and to spice up my code-review presence I manually set my display-name to \"Funny Guy\".\nWon\u0027t this overwrite that setting the next time I log in?\n\nI.e. if we get a display-name from SAML it will change the display-name to that and if we don\u0027t get a display-name from SAML it will delete the display-name I set manually.",
      "range": {
        "startLine": 185,
        "startChar": 12,
        "endLine": 185,
        "endChar": 82
      },
      "revId": "b53e12e5e62c0660389f07bc9679a4218b512bce",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "6b67e489_09c2a14c",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/saml/SamlWebFilter.java",
        "patchSetId": 2
      },
      "lineNbr": 185,
      "author": {
        "id": 1063024
      },
      "writtenOn": "2023-09-05T10:25:41Z",
      "side": 1,
      "message": "That\u0027s a good point, let me do a little digging.\n\nFor clarity, note in Gerrit the value that has to be changed is the account name [1], not the display name, which is what the SAML plugin calls it.\n\nSo we have two cases - when we set our account name locally and when SAML doesn\u0027t pass a display name.\n\nIn the first case, yes that\u0027s what happens. Although that\u0027s what happened before this change too - the display name header is a mandatory field, and the plugin won\u0027t start up unless it\u0027s set.\n\nFor the second case, I\u0027m not sure if it\u0027s possible _not_ to set the display name field in identity providers. The plugin assume it\u0027s mandatory (judging by the docs and the code), and I\u0027ve had a play with Keycloak and as far as I can tell it\u0027s mandatory there too (as `Name ID`). There _is_ a null/length check in Gerrit [2], although I think that code is SAML-agnostic.\n\nSo to wrap up, I don\u0027t think this is a regression, as it was required previously and still is now. I\u0027m not familiar with the actual spec, but behaviour-wise I think we have parity. Am I missing something?\n\n[1] https://gerrit-review.googlesource.com/Documentation/rest-api-accounts.html#set-account-name\n[2] https://gerrit.googlesource.com/gerrit/+/refs/heads/stable-3.8/java/com/google/gerrit/server/account/AuthRequest.java#140",
      "parentUuid": "2525c881_627e6c72",
      "range": {
        "startLine": 185,
        "startChar": 12,
        "endLine": 185,
        "endChar": 82
      },
      "revId": "b53e12e5e62c0660389f07bc9679a4218b512bce",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "5d1eaa5e_12eb3e78",
        "filename": "src/test/java/com/googlesource/gerrit/plugins/saml/SamlWebFilterIT.java",
        "patchSetId": 2
      },
      "lineNbr": 49,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2023-09-05T07:40:21Z",
      "side": 1,
      "message": "Can we set some special characters as display name?\nThe issue was precisely about the inability to store them to the account full name safely without losses, so we can make sure that happens here.",
      "range": {
        "startLine": 49,
        "startChar": 29,
        "endLine": 49,
        "endChar": 60
      },
      "revId": "b53e12e5e62c0660389f07bc9679a4218b512bce",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "1b807073_9a084c53",
        "filename": "src/test/java/com/googlesource/gerrit/plugins/saml/SamlWebFilterIT.java",
        "patchSetId": 2
      },
      "lineNbr": 49,
      "author": {
        "id": 1054778
      },
      "writtenOn": "2023-09-05T08:50:27Z",
      "side": 1,
      "message": "+1",
      "parentUuid": "5d1eaa5e_12eb3e78",
      "range": {
        "startLine": 49,
        "startChar": 29,
        "endLine": 49,
        "endChar": 60
      },
      "revId": "b53e12e5e62c0660389f07bc9679a4218b512bce",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    }
  ]
}